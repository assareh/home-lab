{
  "variables": {
    "consul_version": "1.10.2",
    "authorized_keys": "{{ vault `/packer/data/ssh` `authorized_keys`}}",
    "esxi_hostname": "esxi.local",
    "esxi_password": "{{ vault `/packer/data/esxi` `esxi_password`}}",
    "esxi_username": "{{ vault `/packer/data/esxi` `esxi_username`}}",
    "ssh_password": "{{ vault `/packer/data/ubuntu` `nas`}}",
    "vm-cpu-num": "1",
    "vm-disk-additional-size": "122880",
    "vm-disk-size": "20480",
    "vm-mem-size": "8192",
    "vm-name": "NAS-{{ timestamp }}"
  },
  "builders": [
    {
      "CPUs": "{{user `vm-cpu-num`}}",
      "boot_command": [
        "<enter><wait><f6><wait><esc><wait>",
        "<bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>",
        "<bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>",
        "<bs><bs><bs>",
        "/install/vmlinuz",
        " initrd=/install/initrd.gz",
        " priority=critical",
        " locale=en_US",
        " file=/media/nas_preseed.cfg",
        "<enter>"
      ],
      "disk_additional_size": [
        "{{user `vm-disk-additional-size`}}"
      ],
      "disk_size": "{{user `vm-disk-size`}}",
      "disk_type_id": "thin",
      "floppy_files": [
        "./nas_preseed.cfg"
      ],
      "guest_os_type": "ubuntu-64",
      "iso_checksum": "sha256:8c5fc24894394035402f66f3824beb7234b757dd2b5531379cb310cedfdf0996",
      "iso_url": "https://cdimage.ubuntu.com/releases/18.04/release/ubuntu-18.04.5-server-amd64.iso",
      "keep_registered": true,
      "memory": "{{user `vm-mem-size`}}",
      "network_adapter_type": "vmxnet3",
      "network_name": "VM Network",
      "remote_datastore": "datastore1",
      "remote_host": "{{user `esxi_hostname`}}",
      "remote_password": "{{user `esxi_password`}}",
      "remote_port": 22,
      "remote_type": "esx5",
      "remote_username": "{{user `esxi_username`}}",
      "shutdown_command": "sudo -S shutdown -P now",
      "skip_export": true,
      "ssh_password": "{{user `ssh_password`}}",
      "ssh_username": "ubuntu",
      "type": "vmware-iso",
      "vm_name": "{{user `vm-name`}}",
      "vmx_data": {
        "virtualhw.version": "17"
      },
      "vnc_over_websocket": "true"
    }
  ],
  "provisioners": [
    {
      "expect_disconnect": true,
      "inline": [
        "touch /home/ubuntu/.hushlogin",
        "mkdir -p /home/ubuntu/.ssh",
        "echo '{{user `authorized_keys`}}' > /home/ubuntu/.ssh/authorized_keys",
        "chmod 600 /home/ubuntu/.ssh/authorized_keys",
        "chown -R ubuntu /home/ubuntu/.ssh",
        "sudo sed -i -e 's/#PasswordAuthentication yes/PasswordAuthentication no/g' /etc/ssh/sshd_config",
        "sudo service ssh restart"
      ],
      "type": "shell"
    },
    {
      "inline": [
        "curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -",
        "sudo apt-add-repository \"deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main\"",
        "sudo apt-get update",
        "sudo apt-get upgrade -y",
        "sudo apt-get install -y consul={{user `consul_version`}}",
        "sudo apt-get autoremove -y",
        "sudo -H -u ubuntu consul -autocomplete-install"
      ],
      "type": "shell"
    },
    {
      "destination": "/home/ubuntu/",
      "source": "nas_files/nfs.json",
      "type": "file"
    },
    {
      "destination": "/home/ubuntu/",
      "source": "nas_files/consul.hcl",
      "type": "file"
    },
    {
      "inline": [
        "sudo mv /home/ubuntu/consul.hcl /etc/consul.d/.",
        "sudo mv /home/ubuntu/nfs.json /etc/consul.d/.",
        "sudo chmod 640 /etc/consul.d/*",
        "sudo chown -R consul:consul /etc/consul.d",
        "sudo systemctl enable consul && sudo systemctl start consul"
      ],
      "type": "shell"
    },
    {
      "type": "breakpoint",
      "disable": true,
      "note": "If mirroring the data volume, this is when you would go add the third disk."
    },
    {
      "inline": [
        "sudo zpool create data /dev/sdb",
        "sudo chmod 777 /data",
        "echo \"/data    192.168.0.0/255.255.255.0(rw,sync,no_root_squash,no_subtree_check)\" | sudo tee -a /etc/exports",
        "sudo systemctl restart nfs-kernel-server"
      ],
      "type": "shell"
    }
  ]
}